<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Weather</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1em;
      background: #f5f5f5;
      color: #333;
      font-size: 1.25em;
    }

    h1 { 
      text-align: center; 
      font-size: 1.6em;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5em;
    }

    .left-controls {
      display: flex;
      align-items: center;
      gap: 1em;
    }

    select {
      padding: 1em;
      font-size: 1.3em;
      border-radius: 12px;
      width: 220px;
    }

    #goBtn {
      padding: 1em 1.4em;
      font-size: 1.3em;
      border-radius: 12px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
    }

    #goBtn:active { background: #005fcc; }

    #addBtn {
      background: #28a745;
      font-weight: bold;
      padding: 1em 1.3em;
      font-size: 1.3em;
      border-radius: 12px;
      border: none;
      color: white;
      cursor: pointer;
    }

    #addBtn:active { background: #1f7f35; }

    #weatherContainer {
      margin-top: 2em;
      padding: 1em;
      background: white;
      border-radius: 10px;
      min-height: 40px;
      font-size: 1.25em;
      line-height: 1.6em;
    }

    #locationTitle {
      font-size: 1.6em;
      font-weight: bold;
      margin-bottom: 0.5em;
    }

    .period {
      border-bottom: 1px solid #ddd;
      padding: 0.8em 0;
      font-size: 1.2em;
    }

    .period:last-child { border: none; }

    .temp { font-weight: bold; }
    .shortForecast { font-style: italic; }

    /* Popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .popup {
      background: white;
      padding: 1.5em;
      border-radius: 10px;
      width: 90%;
      max-width: 350px;
      font-size: 1.2em;
    }

    .popup h2 {
      margin-top: 0;
      text-align: center;
      font-size: 1.4em;
    }

    .popup input {
      width: 100%;
      padding: 0.8em;
      font-size: 1.2em;
      margin-top: 0.6em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .popup-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1em;
    }

    .cancel-btn {
      background: #aaa;
      color: white;
      padding: 0.8em 1.2em;
      font-size: 1.2em;
      border-radius: 8px;
      border: none;
    }

    #saveAdd {
      padding: 0.8em 1.2em;
      font-size: 1.2em;
      border-radius: 8px;
      border: none;
      background: #007bff;
      color: white;
    }

    @media (max-width: 600px) {
      select {
        font-size: 1.5em;
        padding: 1.2em;
        width: 100%;
      }
      #goBtn {
        font-size: 1.5em;
        padding: 1.2em 1.6em;
      }
      #addBtn {
        font-size: 1.6em;
        padding: 1em 1.4em;
      }
      #weatherContainer {
        font-size: 1.4em;
      }
    }
  </style>
</head>
<body>

<h1>Mountain Weather</h1>

<div class="top-bar">
  <div class="left-controls">
    <select id="locationSelect">
      <option value="" selected disabled>Select Mountain...</option>
      <option value="copper">Copper Mountain</option>
      <option value="abasin">A-Basin</option>
    </select>

    <button id="goBtn">Go</button>
  </div>

  <button id="addBtn">+</button>
</div>

<div id="weatherContainer">
  <div id="locationTitle"></div>
  <div id="weather"></div>
</div>

<!-- Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup">
    <h2>Add Location</h2>

    <input id="locName" placeholder="Location Name">
    <input id="locLat" placeholder="Latitude" type="number" step="0.00001">
    <input id="locLon" placeholder="Longitude" type="number" step="0.00001">

    <div class="popup-buttons">
      <button class="cancel-btn" id="cancelAdd">Cancel</button>
      <button id="saveAdd">Save</button>
    </div>
  </div>
</div>

<script>

  // ==========================
  // Default Locations
  // ==========================
  const locations = {
    copper: { lat: 39.47523, lon: -106.15228, name: "Copper Mountain" },
    abasin: { lat: 39.6429,  lon: -105.8711,  name: "A-Basin" }
  };

  const weatherDiv = document.getElementById('weather');
  const locationTitle = document.getElementById('locationTitle');
  const locationSelect = document.getElementById('locationSelect');
  const goBtn = document.getElementById('goBtn');

  const popup = document.getElementById('popupOverlay');
  const addBtn = document.getElementById('addBtn');
  const saveAdd = document.getElementById('saveAdd');
  const cancelAdd = document.getElementById('cancelAdd');
  const locName = document.getElementById('locName');
  const locLat = document.getElementById('locLat');
  const locLon = document.getElementById('locLon');


  // ==========================
  // Popup Logic
  // ==========================
  addBtn.onclick = () => { popup.style.display = 'flex'; };

  cancelAdd.onclick = () => {
    popup.style.display = 'none';
    locName.value = "";
    locLat.value = "";
    locLon.value = "";
  };

  saveAdd.onclick = () => {
    const name = locName.value.trim();
    const lat = parseFloat(locLat.value);
    const lon = parseFloat(locLon.value);

    if (!name || isNaN(lat) || isNaN(lon)) {
      alert("Please fill out all fields.");
      return;
    }

    const key = name.toLowerCase().replace(/\s+/g, "_");

    locations[key] = { name, lat, lon };

    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = name;
    locationSelect.appendChild(opt);

    popup.style.display = 'none';
    locName.value = "";
    locLat.value = "";
    locLon.value = "";
  };


  // ==========================
  // Weather Fetch Functions
  // ==========================
  async function getForecast(lat, lon) {
    try {
      weatherDiv.innerText = 'Loading…';

      const pointRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
      const pointJson = await pointRes.json();

      const forecastUrl = pointJson.properties.forecast;

      const forecastRes = await fetch(forecastUrl);
      const forecastJson = await forecastRes.json();

      return forecastJson.properties.periods;
    } catch (err) {
      console.error("Error fetching forecast:", err);
      return null;
    }
  }

  function extractSnowAmount(text) {
    const rangeMatch = text.match(/(\d+)\s*(?:to|-)\s*(\d+)\s*inches/i);
    if (rangeMatch) return `${rangeMatch[1]}–${rangeMatch[2]} inches`;

    const singleMatch = text.match(/around\s*(\d+)\s*inches/i);
    if (singleMatch) return `${singleMatch[1]} inches`;

    const upToMatch = text.match(/up to\s*(\d+)\s*inches/i);
    if (upToMatch) return `Up to ${upToMatch[1]} inches`;

    return null;
  }

  function displayForecast(periods) {
    if (!periods) {
      weatherDiv.innerText = "Could not load forecast.";
      return;
    }

    const limited = periods.slice(0, 6); // 3 days (day/night)

    weatherDiv.innerHTML = limited.map(p => {
      const snow = extractSnowAmount(p.detailedForecast);
      return `
        <div class="period">
          <strong>${p.name}</strong>:
          <span class="shortForecast">${p.shortForecast}</span>,
          <span class="temp">${p.temperature}°${p.temperatureUnit}</span><br>
          ${snow ? `<span style="color:#0077cc;"><strong>Estimated Snow:</strong> ${snow}</span>` : ""}
        </div>
      `;
    }).join('');
  }

  async function updateWeather() {
    const selected = locationSelect.value;

    if (!selected) {
      weatherDiv.innerText = "Please select a mountain.";
      locationTitle.innerText = "";
      return;
    }

    const selectedLoc = locations[selected];
    locationTitle.innerText = selectedLoc.name;

    const periods = await getForecast(selectedLoc.lat, selectedLoc.lon);
    displayForecast(periods);
  }

  goBtn.addEventListener('click', updateWeather);

</script>

</body>
</html>
